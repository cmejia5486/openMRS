name: Mobile Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  mobsf_scan:
    runs-on: self-hosted        # Usa el runner auto‑hospedado
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Build Android app
        run: .\gradlew.bat assembleRelease
        shell: powershell
        continue-on-error: true

      - name: Upload app to MobSF and run scan
        env:
          MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
        continue-on-error: true
        shell: powershell
        run: |
          # Localizar el APK generado
          $apkFile = Get-ChildItem -Path . -Recurse -Filter '*.apk' | Select-Object -First 1
          if (-not $apkFile) {
            Write-Error "APK file not found. Please ensure the build step produced an APK."
            exit 1
          }
          # Preparar claves y ruta
          $apkPath = $apkFile.FullName
          $apiKey  = $env:MOBSF_API_KEY
          # Subir el APK a MobSF usando multipart/form-data
          $uploadResult = curl.exe -s -X POST "http://localhost:8000/api/v1/upload" `
            -H "Authorization: $apiKey" `
            -F "file=@$apkPath"
          $uploadResponse = $uploadResult | ConvertFrom-Json
          $hash = $uploadResponse.hash
          Write-Host "Scan hash: $hash"
          # Iniciar el análisis (sin re_scan, que causaba 422)
          $scanBody = @{ scan_type = 'apk'; hash = $hash }
          Invoke-RestMethod -Uri "http://localhost:8000/api/v1/scan" `
            -Method Post `
            -Headers @{ Authorization = $apiKey } `
            -Body ($scanBody | ConvertTo-Json) `
            -ContentType 'application/json'
          # Descargar el reporte JSON y guardarlo
          $report = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/report_json?hash=$hash" `
            -Method Get `
            -Headers @{ Authorization = $apiKey }
          $report | ConvertTo-Json | Set-Content mobsf_results.json

      - name: Upload MobSF results
        uses: actions/upload-artifact@v4
        with:
          name: mobsf-report
          path: mobsf_results.json
