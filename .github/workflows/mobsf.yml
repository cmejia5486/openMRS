name: Mobile Security Scan

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  mobsf_scan:
    runs-on: [self-hosted, mobsf]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Build Android app
        run: .\\gradlew.bat assembleRelease
        shell: powershell
          continue-on-error: true

      - name: Upload app to MobSF and run scan
        env:
          MOBSF_API_KEY: ${{ secrets.MOBSF_API_KEY }}
        run: |
          $apkFile = Get-ChildItem -Path . -Recurse -Filter *.apk | Select-Object -First 1
          if (-not $apkFile) {
            Write-Error "APK file not found. Please ensure the build step produced an APK."
          }
          $uploadResponse = Invoke-RestMethod -Uri "http://localhost:8000/api/v1/upload" -Headers @{Authorization=$env:MOBSF_API_KEY} -Method Post -InFile $apkFile.FullName -ContentType "application/octet-stream"
          $hash = $uploadResponse.hash
          Write-Host "Scan hash: $hash"
          $scanBody = @{ scan_type = "apk"; hash = $hash; re_scan = $false } | ConvertTo-Json
          Invoke-RestMethod -Uri "http://localhost:8000/api/v1/scan" -Headers @{Authorization=$env:MOBSF_API_KEY; 'Content-Type' = 'application/json'} -Method Post -Body $scanBody
          Invoke-RestMethod -Uri "http://localhost:8000/api/v1/report_json?hash=$hash" -Headers @{Authorization=$env:MOBSF_API_KEY} -OutFile mobsf_results.json
        shell: powershell

      - name: Upload MobSF results
        uses: actions/upload-artifact@v4
        with:
          name: mobsf-report
          path: mobsf_results.json
