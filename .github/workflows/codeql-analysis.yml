name: Static SAST (CodeQL)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast:
    name: SAST (no build, security-only, report-only)
    # Evita ejecutar con Dependabot
    if: ${{ github.actor != 'dependabot[bot]' && !startsWith(github.head_ref || github.ref_name || '', 'dependabot/') }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- CodeQL (Java) sin build, solo seguridad ---
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: none
          config-file: .github/codeql/codeql-security.yml

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          output: report/codeql      # guarda SARIF local
          upload: always             # y lo sube a Code Scanning
        continue-on-error: true       # no falla el job por findings

      # --- Detekt (Kotlin) CLI (solo artefacto, no subir a Security) ---
      - name: Set up JDK (for Detekt CLI)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Setup detekt CLI
        uses: peter-murray/setup-detekt@v3

      - name: Run detekt (Kotlin → SARIF)
        run: |
          mkdir -p report
          detekt-cli -i . --all-rules --report sarif:report/detekt.sarif || true

      # --- Semgrep (Java + Kotlin) security packs ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install --upgrade semgrep

      - name: Run Semgrep (security packs → SARIF)
        run: |
          mkdir -p report
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --severity WARNING --severity ERROR \
            --sarif --output report/semgrep.raw.sarif || true

      # --- Filtrar SARIF de Semgrep (excluir tests y rutas ruidosas) ---
      - name: Filter Semgrep SARIF (keep app code only)
        uses: advanced-security/filter-sarif@v1
        with:
          input: report/semgrep.raw.sarif
          output: report/semgrep.sarif
          # Incluye solo código de app y excluye tests
          patterns: |
            -**/test/**
            -**/androidTest/**
            -**/*Test*.kt
            -**/*Test*.java
            **/src/**

      # Subir a Code Scanning solo los SARIF de seguridad
      - name: Upload Semgrep (security-only) to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report/semgrep.sarif
        continue-on-error: true

      # --- Fusionar SARIFs y publicar artefacto ---
      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Merge SARIFs (CodeQL + Detekt + Semgrep)
        shell: bash
        run: |
          shopt -s nullglob
          mkdir -p report
          files=(report/codeql/*.sarif report/detekt.sarif report/semgrep.sarif)
          if [ ${#files[@]} -gt 0 ]; then
            jq -s '{ "version":"2.1.0", "runs": (map(.runs) | add) }' "${files[@]}" > report/merged.sarif
          else
            echo '{ "version":"2.1.0", "runs": [] }' > report/merged.sarif
          fi

      - name: Upload findings artifact (para otros jobs / IA)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-findings
          path: |
            report/*.sarif
            report/codeql/*.sarif
          if-no-files-found: warn
