name: CodeQL Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: CodeQL (manual build)
    # No ejecutes si el actor es Dependabot o la rama del PR es dependabot/*
    if: ${{ github.actor != 'dependabot[bot]' && !startsWith(github.head_ref || github.ref_name || '', 'dependabot/') }}

    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Gradle 6.5 es compatible con JDK 11 (no con 17)
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: gradle

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java          # Kotlin queda cubierto por 'java'
          build-mode: manual

      - name: Grant execute permission for Gradle
        run: chmod +x gradlew

      # Ajusta el task según tu proyecto:
      # - Android app: ./gradlew :app:assembleDebug (requiere SDK Android instalado)
      # - JVM genérico: ./gradlew build
      - name: Build (manual)
        run: ./gradlew build -x test --no-daemon --stacktrace

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
