jobs:
  sast:
    name: SAST (no build, report-only)
    if: ${{ github.actor != 'dependabot[bot]' && !startsWith(github.head_ref || github.ref_name || '', 'dependabot/') }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- CodeQL (Java) sin build ---
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          build-mode: none

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          # guarda SARIF localmente y súbelo a Code Scanning
          output: report/codeql
          upload: always

      # --- Detekt (Kotlin) CLI (sin Gradle) ---
      - name: Set up JDK (for Detekt CLI)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Setup detekt CLI
        uses: peter-murray/setup-detekt@v3

      - name: Run detekt (Kotlin → SARIF)
        run: |
          mkdir -p report
          detekt-cli \
            -i . \
            --all-rules \
            --report sarif:report/detekt.sarif || true

      - name: Upload Detekt to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report/detekt.sarif

      # --- Semgrep (Java + Kotlin) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install --upgrade semgrep

      - name: Run Semgrep (→ SARIF)
        run: |
          mkdir -p report
          semgrep --config p/java --config p/kotlin --sarif --output report/semgrep.sarif || true

      - name: Upload Semgrep to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report/semgrep.sarif

      # --- Fusionar SARIF y publicar artefacto ---
      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Merge SARIFs
        shell: bash
        run: |
          shopt -s nullglob
          files=(report/codeql/*.sarif report/detekt.sarif report/semgrep.sarif)
          if [ ${#files[@]} -gt 0 ]; then
            jq -s '{ "version":"2.1.0", "runs": (map(.runs) | add) }' "${files[@]}" > report/merged.sarif
          else
            echo '{ "version":"2.1.0", "runs": [] }' > report/merged.sarif
          fi

      - name: Upload findings artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-findings
          path: |
            report/*.sarif
            report/codeql/*.sarif
          if-no-files-found: warn
