# .github/workflows/codeql-analysis.yml
name: Static SAST (CodeQL)

"on":
  workflow_call:
    inputs:
      languages:
        required: false
        type: string
        default: "java,kotlin"
      build-mode:
        required: false
        type: string
        default: "none"

# Necesario para subir SARIF a Code Scanning
permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast:
    name: CodeQL + Detekt + Semgrep
    if: ${{ github.actor != 'dependabot[bot]' &&
            !(github.head_ref != '' && startsWith(github.head_ref, 'dependabot/')) &&
            !(github.ref_name != '' && startsWith(github.ref_name, 'dependabot/')) }}
    runs-on: ubuntu-latest
    steps:
      # --- Código original conservado; sólo actualicé versiones y robustecí pasos ---
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.languages }}
          build-mode: ${{ inputs['build-mode'] }}

      # Si alguna vez decides compilar: usa autobuild, pero por defecto build-mode=none
      # - name: Autobuild
      #   uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ inputs.languages }}"

      # ---- Detekt (mantengo tu configuración) ----
      - name: Set up JDK (for Detekt CLI)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup detekt CLI
        uses: peter-murray/setup-detekt@v3

      - name: Run detekt (Kotlin → SARIF)
        run: |
          mkdir -p report/codeql
          detekt-cli -i . --all-rules --report sarif:report/detekt.sarif || true

      # ---- Semgrep (mantengo tu configuración) ----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Semgrep
        run: |
          pip install --upgrade semgrep

      - name: Run Semgrep (security packs → SARIF)
        run: |
          mkdir -p report
          semgrep scan \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --severity WARNING --severity ERROR \
            --sarif --output report/semgrep.raw.sarif || true

      - name: Filter Semgrep SARIF (keep app code only)
        uses: advanced-security/filter-sarif@v1
        with:
          patterns: |
            **/*.java
            **/*.kt
            **/*.kts
            **/*.gradle
            **/*.xml
          input: report/semgrep.raw.sarif
          output: report/semgrep.sarif

      - name: Upload Semgrep (security-only) to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report/semgrep.sarif

      # ---- Merge SARIFs (tu lógica, sin '...' literales) ----
      - name: Ensure jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Merge SARIFs (CodeQL + Detekt + Semgrep)
        run: |
          shopt -s nullglob
          mkdir -p report/codeql
          files=(report/codeql/*.sarif report/detekt.sarif report/semgrep.sarif)
          if [ ${#files[@]} -gt 0 ]; then
            jq -s '{ "version":"2.1.0", "runs": (map(.runs) | add) }' "${files[@]}" > report/merged.sarif
          else
            echo '{ "version":"2.1.0", "runs": [] }' > report/merged.sarif
          fi

      - name: Upload findings artifact (para otros jobs / IA)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-findings
          path: |
            report/*.sarif
            report/codeql/*.sarif
          if-no-files-found: warn
