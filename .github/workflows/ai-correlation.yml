name: AI Correlation

# This workflow runs when other security workflows complete successfully.
# It downloads their artifacts, invokes an AI assistant to correlate
# findings against your security requirements checklist, and publishes
# a summary report.  To enable this workflow, commit this file to
# `.github/workflows/` in your repository and provide an `OPENAI_API_KEY`
# secret in your repository settings.

on:
  workflow_run:
    workflows: ["Security Scans", "CodeQL Analysis", "Mobile Security Scan", "Compliance Check"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  correlate:
    # only run if the triggering workflow completed successfully
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Download artifacts from previous workflows. Adjust names to match
      # the artifacts produced by your scanners (e.g. 'mobsf-report',
      # 'reports-codeql', 'reports-trivy', 'compliance-report').
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --no-cache-dir openai pandas

      - name: Run AI correlation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/ai_correlate.py \
            --checklist requirements/checklist.json \
            --reports reports \
            --output report/ai_summary.md

      - name: Upload AI summary
        uses: actions/upload-artifact@v4
        with:
          name: ai-summary
          path: report/